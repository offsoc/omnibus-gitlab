name: Build Omnibus packages

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build-packages:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [debian12, debian13, ubuntu25]
    env:
      COMPRESS_XZ: "true"
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      ee: "true"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install OS-specific dependencies
        run: |
          case ${{ matrix.os }} in
            debian10)
              # Install Debian 12 specific packages
              sudo apt-get update
              sudo apt-get install -y build-essential ruby ruby-dev libssl-dev zlib1g-dev \
                libffi-dev libreadline-dev libyaml-dev libxml2-dev libxslt1-dev \
                libpq-dev libsqlite3-dev libmysqlclient-dev libcurl4-openssl-dev \
                libicu-dev cmake pkg-config xz-utils curl git
              ;;
            debian11)
              # Install Debian 13 specific packages
              sudo apt-get update
              sudo apt-get install -y build-essential ruby ruby-dev libssl-dev zlib1g-dev \
                libffi-dev libreadline-dev libyaml-dev libxml2-dev libxslt1-dev \
                libpq-dev libsqlite3-dev libmysqlclient-dev libcurl4-openssl-dev \
                libicu-dev cmake pkg-config xz-utils curl git
              ;;
            ubuntu20)
              # Install Ubuntu 25.04 specific packages
              sudo apt-get update
              sudo apt-get install -y build-essential ruby ruby-dev libssl-dev zlib1g-dev \
                libffi-dev libreadline-dev libyaml-dev libxml2-dev libxslt1-dev \
                libpq-dev libsqlite3-dev libmysqlclient-dev libcurl4-openssl-dev \
                libicu-dev cmake pkg-config xz-utils curl git
              ;;
          esac

      - name: Install Ruby gems
        run: |
          # Use sudo to install bundler system-wide
          sudo gem install bundler
          # Configure bundle to use local path
          bundle config set --local path 'vendor/bundle'
          bundle install --jobs 4 --retry 3
          bundle binstubs --all

      - name: Build Omnibus package
        run: |
          # Build gitlab omnibus package (outputs go to pkg/)
          bundle exec omnibus build gitlab
        env:
          COMPRESS_XZ: "true"
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: List produced packages
        run: ls -al pkg || true

      - name: Upload Debian packages
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deb-packages-${{ matrix.os }}
          path: |
            pkg/**/*.deb

      - name: Upload RPM packages
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rpm-packages-${{ matrix.os }}
          path: |
            pkg/**/*.rpm
