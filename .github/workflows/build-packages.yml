name: GitLab EE Production Build (Official Sequence)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  EE: "true"
  ee: "true"
  COMPILE_ASSETS: "true"
  SKIP_CHECK_NO_CHANGES: "true"
  # 官方 Builder 镜像，内含所有 Rake 任务所需的工具链
  BUILDER_IMAGE: "registry.gitlab.com/gitlab-org/gitlab-build-images/omnibus-gitlab-builder:ubuntu-22.04"

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: registry.gitlab.com/gitlab-org/gitlab-build-images/omnibus-gitlab-builder:ubuntu-22.04
      options: --user root

    steps:
      - name: 1. 检出源码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2. 注入补丁并强制 EE 版本
        run: |
          # 确保 VERSION 文件符合 EE 规范
          [[ ! $(cat VERSION) == *"-ee"* ]] && echo "$(cat VERSION)-ee" > VERSION
          
          # 动态注入自定义补丁到 Rails 软件定义
          RAILS_DEF="config/software/gitlab-rails.rb"
          PATCH_NAME="replace-license-key.patch"
          if [ -f "config/patches/gitlab-rails/$PATCH_NAME" ]; then
            sed -i "/patch source: '.*.patch'/a \  patch source: '$PATCH_NAME'" "$RAILS_DEF"
          fi

      - name: 3. 准备构建环境 (Bundler)
        run: |
          mkdir -p /opt/gitlab /var/cache/omnibus ~/.ssh
          bundle install --jobs 4 --retry 3

      - name: 4. 执行官方构建序列 (Strict Official Sequence)
        run: |
          # 步骤 A: 处理缓存 (提高后续构建速度)
          bundle exec rake cache:populate
          bundle exec rake cache:restore
          
          # 步骤 B: 核心项目构建 (应用补丁并编译)
          bundle exec rake build:project
          
          # 步骤 C: 生成组件版本清单 (生产审计必备)
          bundle exec rake build:component_shas
          
          # 步骤 D: 更新并打包新缓存
          bundle exec rake cache:bundle

      - name: 5. 校验与上传产物
        run: |
          cd pkg/
          sha256sum *.deb > SHA256SUMS || true
          sha256sum *.rpm >> SHA256SUMS || true

      - name: 6. 归档到 GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gitlab-ee-production-pkg
          path: |
            pkg/*.deb
            pkg/*.rpm
            pkg/SHA256SUMS
