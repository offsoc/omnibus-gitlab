name: GitLab EE Production Build

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        # 同时构建 Ubuntu (deb) 和 CentOS (rpm) 兼容环境
        include:
          - os: ubuntu-22.04
            pkg_type: deb
          - os: ubuntu-20.04 # 模拟较旧环境以构建兼容性更好的包
            pkg_type: rpm # 在 Ubuntu 上也可以通过安装 rpm 工具来构建 rpm
      fail-fast: false
    runs-on: ${{ matrix.os }}
    
    env:
      EE: "true"
      SKIP_CHECK_NO_CHANGES: "true" # 允许带补丁构建
      BUNDLE_JOBS: "4"
      COMPILE_CONCURRENCY: "4"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. 生产环境磁盘空间优化 (GitLab 编译需约 40GB 空间)
      - name: Maximize Build Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            m4  autoconf  automake  libtool  patch   bison  flex  build-essential  pkg-config  libssl-dev   libyaml-dev libreadline-dev zlib1g-dev  libncurses5-dev  libffi-dev   libgdbm-dev
            
          sudo mkdir -p /opt/gitlab /var/cache/omnibus
          sudo chown -R $USER:$USER /opt/gitlab /var/cache/omnibus

      # 2. 设置 Ruby 
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      # 3. 核心步骤：注入自定义 License 补丁
      # 必须在 gitlab-rails 软件定义中注册补丁，否则编译时会忽略文件夹里的 patch 文件
      - name: Inject Custom Patches
        run: |
          RAILS_DEF="config/software/gitlab-rails.rb"
          PATCH_NAME="replace-license-key.patch"
          
          if [ -f "config/patches/gitlab-rails/$PATCH_NAME" ]; then
            echo "Registering $PATCH_NAME in $RAILS_DEF"
            # 在已有的 patch 声明行之后插入我们的自定义补丁声明
            sed -i "/patch source: '.*.patch'/a \  patch source: '$PATCH_NAME'" "$RAILS_DEF"
          else
            echo "Error: Patch $PATCH_NAME not found!"
            exit 1
          fi

      # 4. 执行构建
      - name: Run Omnibus Build
        run: |
          # 根据 matrix 决定构建任务
          if [[ "${{ matrix.pkg_type }}" == "deb" ]]; then
            bundle exec rake build:project
          else
            # 构建 RPM 需要显式指定（Omnibus 会根据系统环境自动识别，但这里确保环境工具链完整）
            bundle exec rake build:project
          fi

      # 5. 产物校验
      - name: Verify and Sign
        run: |
          cd pkg/
          sha256sum *.${{ matrix.pkg_type }} > checksums.txt
          ls -lh

      # 6. 存储产物
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gitlab-ee-${{ matrix.os }}-${{ matrix.pkg_type }}
          path: |
            pkg/*.deb
            pkg/*.rpm
            pkg/checksums.txt
          retention-days: 14
