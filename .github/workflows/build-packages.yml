name: Build GitLab EE Packages

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 2 * * 1'  # Weekly builds on Mondays at 2 AM UTC

jobs:
  build-packages:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - os: ubuntu20
            image: ubuntu:20.04
          - os: ubuntu22
            image: ubuntu:22.04
          - os: debian11
            image: debian:bullseye
          - os: debian12
            image: debian:bookworm
      fail-fast: false
      max-parallel: 2
    env:
      ee: "true"
      COMPRESS_XZ: "true"
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      BUNDLE_JOBS: "4"
      BUNDLE_RETRY: "3"
      BUILD_LOG_LEVEL: ${{ inputs.debug && 'debug' || 'info' }}
      DEBUG: ${{ inputs.debug && 'true' || 'false' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: System diagnostics
        run: |
          echo "=== System Info ==="
          uname -a
          date
          df -h
          free -h
          lscpu | head -n 10
          if [[ "${{ env.DEBUG }}" == "true" ]]; then env | sort; fi

      - name: Setup environment
        run: |
          mkdir -p $HOME/.cache/omnibus $HOME/pkg $HOME/.bundle
          chmod 755 $HOME/.cache/omnibus $HOME/pkg
          echo "OMNIBUS_CACHE_DIR=$HOME/.cache/omnibus" >> $GITHUB_ENV
          echo "PKG_DIR=$HOME/pkg" >> $GITHUB_ENV

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2.8
          bundler-cache: true

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential libssl-dev zlib1g-dev libffi-dev \
            libreadline-dev libyaml-dev libxml2-dev libxslt1-dev \
            libpq-dev libsqlite3-dev libmysqlclient-dev \
            libcurl4-openssl-dev libicu-dev cmake pkg-config \
            xz-utils curl git ca-certificates rpm fakeroot
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* 2>/dev/null || true

      - name: Install Ruby gems
        run: |
          echo "=== Installing Ruby Gems ==="
          echo "BUNDLER_VERSION=2.7.1" >> $GITHUB_ENV
          bash scripts/ci/prepare_bundle.sh
          bundle binstubs --all --force

      - name: Validate build requirements
        run: |
          PATCH_FILE="config/patches/gitlab-rails/replace-license-key.patch"
          if [ ! -f "$PATCH_FILE" ]; then
            echo "::error::Critical patch file not found: $PATCH_FILE"
            exit 1
          fi
          echo "✓ Patch file verified: $PATCH_FILE"

      - name: Build GitLab EE packages
        run: |
          echo "=== Prepare directories and cache ==="
          mkdir -p $HOME/.cache/omnibus $HOME/pkg ~/.ssh ~/.aws cache
          chmod 755 $HOME/.cache/omnibus $HOME/pkg

          if [ -n "$DEV_GITLAB_SSH_KEY" ]; then
            echo "$DEV_GITLAB_SSH_KEY" > ~/.ssh/id_rsa
            cp support/known_hosts ~/.ssh/known_hosts
            chmod 600 ~/.ssh/id_rsa ~/.ssh/known_hosts
          fi

          echo "=== Install Omnibus gem and binstub ==="
          gem install omnibus -v '9.0.19' --no-document
          bundle binstubs omnibus --force
          export PATH=$PWD/bin:$PATH

          TEMP_OMNIBUS_CONFIG="/tmp/omnibus_config.rb"
          cat > "$TEMP_OMNIBUS_CONFIG" << EOF
          cache_dir '$HOME/.cache/omnibus' 
          use_s3_caching false
          fetcher_progress_bar false
          build_retries 2
          fetcher_retries 5
          append_timestamp false
          EOF

          echo "=== Start Omnibus build ==="
          bin/omnibus --config-file "$TEMP_OMNIBUS_CONFIG" build gitlab --log-level "$BUILD_LOG_LEVEL"

        env:
          ee: "true"
          COMPRESS_XZ: "true"
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          PKG_DIR: $HOME/pkg
          NIGHTLY: ""

      - name: Package verification and listing
        run: |
          echo "=== Build Summary ==="
          ls -la pkg/ 2>/dev/null || echo "No packages directory found"

          DEB_COUNT=$(find pkg/ -name "*.deb" -type f 2>/dev/null | wc -l)
          RPM_COUNT=$(find pkg/ -name "*.rpm" -type f 2>/dev/null | wc -l)
          echo "DEB packages: $DEB_COUNT, RPM packages: $RPM_COUNT"
          TOTAL_PACKAGES=$((DEB_COUNT + RPM_COUNT))
          echo "Total packages: $TOTAL_PACKAGES"
          if [ "$TOTAL_PACKAGES" -eq 0 ]; then echo "::warning::No packages generated"; fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitlab-ee-${{ matrix.os }}-${{ github.sha }}
          path: |
            pkg/**
            build_facts/**
            omnibus.log
            build.log
          retention-days: ${{ inputs.debug && 7 || 30 }}
          compression-level: 6
          if-no-files-found: warn

      - name: Workflow completion notice
        if: always()
        run: |
          echo "✅ Build workflow completed"
          exit 0

      - name: Cleanup workspace
        if: always()
        run: |
          rm -rf vendor/bundle/ruby/*/cache $HOME/.cache/omnibus tmp/ 2>/dev/null || true
          find $HOME/.gem -name "*.gem" -delete 2>/dev/null || true
          du -sh . || echo "Unable to calculate disk usage"
          df -h . || echo "Unable to show filesystem info"
