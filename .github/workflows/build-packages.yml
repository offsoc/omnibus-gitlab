name: GitLab EE Production Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-packages:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - platform: ubuntu-22.04
            builder_image: registry.gitlab.com/gitlab-org/gitlab-build-images/omnibus-gitlab-builder:ubuntu-22.04
            pkg_ext: deb
          - platform: centos-8
            builder_image: registry.gitlab.com/gitlab-org/gitlab-build-images/omnibus-gitlab-builder:centos-8
            pkg_ext: rpm
      fail-fast: false

    container:
      image: ${{ matrix.builder_image }}
      options: --user root

    # 修复：只保留一个大写的 EE，官方脚本同样能识别
    env:
      EE: "true"
      COMPILE_ASSETS: "true"
      SKIP_CHECK_NO_CHANGES: "true"
      BUNDLE_JOBS: "4"
      COMPILE_CONCURRENCY: "4"

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2. Prepare Environment
        run: |
          # 确保版本后缀正确
          if [[ ! $(cat VERSION) == *"-ee"* ]]; then
            echo "$(cat VERSION)-ee" > VERSION
          fi
          
          # 创建必要目录
          mkdir -p /opt/gitlab /var/cache/omnibus
          
          # 安装依赖
          bundle install --retry 3
          bundle binstubs --all

      - name: 3. Inject Custom Patches
        run: |
          RAILS_DEF="config/software/gitlab-rails.rb"
          PATCH_NAME="replace-license-key.patch"
          
          if [ -f "config/patches/gitlab-rails/$PATCH_NAME" ]; then
            # 动态注册补丁到 Omnibus 软件定义
            sed -i "/patch source: '.*.patch'/a \  patch source: '$PATCH_NAME'" "$RAILS_DEF"
            echo "✓ Patch registered."
          fi

      - name: 4. Execute Official Build Sequence
        run: |
          # 严格按照你提供的官方任务序列执行
          bundle exec rake cache:populate
          bundle exec rake cache:restore
          
          # 核心构建任务 (应用补丁并打包)
          bundle exec rake build:project
          
          # 生成组件版本清单
          bundle exec rake build:component_shas
          
          # 打包新缓存 (可选)
          bundle exec rake cache:bundle

      - name: 5. Verify Artifacts
        run: |
          ls -lh pkg/
          cd pkg/
          sha256sum *.${{ matrix.pkg_ext }} > SHA256SUMS

      - name: 6. Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gitlab-ee-official-${{ matrix.platform }}
          path: |
            pkg/*.deb
            pkg/*.rpm
            pkg/SHA256SUMS
