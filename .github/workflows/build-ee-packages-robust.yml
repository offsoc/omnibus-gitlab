name: Build GitLab EE Packages (Robust)

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build-ee-package:
    runs-on: ubuntu-latest
    env:
      ee: "true"
      COMPRESS_XZ: "true"
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ruby ruby-dev \
            libssl-dev \
            zlib1g-dev \
            libffi-dev \
            libreadline-dev \
            libyaml-dev \
            libxml2-dev \
            libxslt1-dev \
            libpq-dev \
            libsqlite3-dev \
            libmysqlclient-dev \
            libcurl4-openssl-dev \
            libicu-dev \
            cmake \
            pkg-config \
            xz-utils \
            curl \
            git \
            ca-certificates

      - name: Setup Ruby environment
        run: |
          # Remove any existing bundler to avoid conflicts
          sudo gem uninstall bundler --all --executables || true
          # Install specific bundler version from Gemfile.lock
          sudo gem install bundler -v "$(grep -A 1 "BUNDLED WITH" Gemfile.lock | tail -1 | tr -d '[:space:]')" || sudo gem install bundler
          # Configure gem environment
          gem env

      - name: Install gems with proper configuration
        run: |
          # Configure bundle to use vendor directory and avoid system conflicts
          bundle config set --local path 'vendor/bundle'
          bundle config set --local bin 'vendor/bundle/bin'
          bundle config set --local without 'development test'
          # Install gems
          bundle install --jobs 4 --retry 3
          bundle binstubs --all

      - name: Quick patch presence check
        run: |
          if [ -f config/patches/gitlab-rails/replace-license-key.patch ]; then
            echo "Patch file present: config/patches/gitlab-rails/replace-license-key.patch"
          else
            echo "WARNING: patch file not found"; exit 1
          fi

      - name: Build GitLab EE Omnibus package
        run: |
          # Build GitLab EE omnibus package (outputs go to pkg/)
          bundle exec omnibus build gitlab
        env:
          ee: "true"
          COMPRESS_XZ: "true"
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: List produced EE packages
        run: ls -al pkg || true

      - name: Upload EE artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitlab-ee-packages-robust
          path: |
            pkg/**